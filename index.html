<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #f2f2f7);
            --text-color: var(--tg-theme-text-color, #000000);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #8e8e93);
            --danger: #ff3b30;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 16px 16px 100px 16px; }
        .screen { 
            display: none; 
            opacity: 0;
            transform: translateX(12px);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out;
        }
        .screen.active { 
            display: block; 
            opacity: 1;
            transform: translateX(0);
        }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .main-btn { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--hint); background: var(--card-bg); color: var(--text-color); font-weight: bold; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: var(--accent-text); border: none; }
        .offer-card { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(0,0,0,0.05); }
        .price { color: var(--accent); font-weight: 800; font-size: 16px; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–ú–µ–Ω—é –∏–∑–º–µ–Ω–µ–Ω–∏—è) */
        .modal { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            align-items: flex-end; 
            z-index: 2000; 
        }
        .modal.active { 
            display: flex; 
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content { 
            background: var(--bg-color); 
            width: 100%; 
            padding: 25px; 
            border-radius: 20px 20px 0 0; 
        }
        .modal.active .modal-content {
            animation: slideUp 0.25s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .input-price { width: 100%; padding: 15px; font-size: 18px; border-radius: 10px; border: 1px solid var(--hint); margin: 15px 0; text-align: center; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="app">
        <div id="screen-welcome" class="screen active">
            <h2 style="text-align:center">–ì–æ—Ä–±—É—à–∫–∞ –û–Ω–ª–∞–π–Ω</h2>
            <div class="card">
                <button class="main-btn btn-primary" onclick="setRole('buyer')">üõí –Ø –ü–æ–∫—É–ø–∞—Ç–µ–ª—å</button>
                <button class="main-btn" onclick="setRole('seller')">üì¶ –Ø –ü—Ä–æ–¥–∞–≤–µ—Ü</button>
            </div>
        </div>

        <div id="screen-main" class="screen">
            <h2 id="menu-title" style="text-align:center">–ú–µ–Ω—é</h2>
            <div class="card">
                <button class="main-btn btn-primary" id="btn-buy" onclick="showScreen('screen-catalog')">üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                <button class="main-btn" id="btn-my-items" onclick="showScreen('screen-my-items')">üìã –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</button>
                <button class="main-btn" id="btn-template" style="background:#34c759; color:white; border:none;" onclick="tg.sendData('REQ_TEMPLATE')">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel</button>
            </div>
            <button class="main-btn" style="color:var(--danger); border:none;" onclick="location.reload()">üö™ –í—ã–π—Ç–∏</button>
        </div>

        <div id="screen-catalog" class="screen">
            <h2 style="text-align:center">–ü–æ–∏—Å–∫</h2>
            <div id="catalog-container"></div>
            <button class="main-btn" onclick="showScreen('screen-main')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
        </div>

        <div id="screen-my-items" class="screen">
            <h2 style="text-align:center">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏</h2>
            <div id="my-items-container"></div>
            <button class="main-btn" onclick="showScreen('screen-main')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="modal-edit" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="edit-title" style="margin-top:0">–¢–æ–≤–∞—Ä</h3>
            <input type="number" id="new-price" class="input-price" placeholder="–ù–æ–≤–∞—è —Ü–µ–Ω–∞">
            <div style="display:flex; gap:10px">
                <button class="main-btn" style="background:var(--danger); color:white; border:none; flex:1" onclick="deleteItem()">–£–¥–∞–ª–∏—Ç—å üóë</button>
                <button class="main-btn btn-primary" style="flex:1" onclick="savePrice()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å üíæ</button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        const myId = 464896073; 
        let dbOffers = [];
        let selectedSku = null;

        async function init() {
            try {
                const res = await fetch("http://127.0.0.1:8080/api/offers");
                dbOffers = await res.json();
            } catch (e) { console.log("–ë–∞–∑–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞"); }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-my-items') renderSellerItems();
            if(id === 'screen-catalog') renderCatalog();
        }

        function setRole(role) {
            if(role === 'seller' && myId !== 464896073) return alert("–û—Ç–∫–∞–∑");
            document.getElementById('btn-my-items').style.display = (role === 'seller') ? 'block' : 'none';
            document.getElementById('btn-template').style.display = (role === 'seller') ? 'block' : 'none';
            document.getElementById('btn-buy').style.display = (role === 'buyer') ? 'block' : 'none';
            showScreen('screen-main');
        }

        function renderSellerItems() {
            const cont = document.getElementById('my-items-container');
            const myData = dbOffers.filter(o => o.seller_id === myId);
            if(myData.length === 0) return cont.innerHTML = '<div class="card">–ü—É—Å—Ç–æ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel.</div>';
            
            cont.innerHTML = myData.map(o => `
                <div class="offer-card" onclick="openEdit('${o.sku}', '${o.product}', ${o.price})">
                    <div style="text-align:left">
                        <b>${o.product}</b><br><small style="color:var(--hint)">SKU: ${o.sku}</small>
                    </div>
                    <div class="price">${o.price.toLocaleString()} ‚ÇΩ</div>
                </div>
            `).join('');
        }

        function renderCatalog() {
            const cont = document.getElementById('catalog-container');
            if(dbOffers.length === 0) return cont.innerHTML = '<div class="card">–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ.</div>';
            
            cont.innerHTML = dbOffers.map(o => `
                <div class="offer-card">
                    <div style="text-align:left"><b>${o.product}</b><br><small>@${o.username}</small></div>
                    <div class="price">${o.price.toLocaleString()} ‚ÇΩ</div>
                    <button class="btn-primary" style="padding:5px 10px; border-radius:5px" onclick="tg.sendData('REQ_BUY|${o.seller_id}|${o.username}|${o.product}|${o.price}')">üõç</button>
                </div>
            `).join('');
        }

        function openEdit(sku, name, price) {
            selectedSku = sku;
            document.getElementById('edit-title').innerText = name;
            document.getElementById('new-price').value = price;
            document.getElementById('modal-edit').classList.add('active');
        }

        function closeModal() { document.getElementById('modal-edit').classList.remove('active'); }

        function savePrice() {
            const price = document.getElementById('new-price').value;
            const name = document.getElementById('edit-title').innerText;
            tg.sendData(`NEW_PRICE|${name}|${price}`);
            closeModal();
            alert("–ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É");
        }

        function deleteItem() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?")) {
                tg.sendData(`DELETE_OFFER|${selectedSku}`);
                closeModal();
            }
        }

        init();
    </script>
</body>
</html>